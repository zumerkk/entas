name: ENTAŞ CI/CD

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main]

env:
  NODE_VERSION: '20'
  PNPM_VERSION: '9'

jobs:
  # ─── Lint & Type Check ───
  lint:
    name: Lint & Types
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: |
          pnpm --filter @entec/shared build
          pnpm --filter @entec/ui build

      - name: Lint API
        run: pnpm --filter @entec/api lint

      - name: Build API
        run: pnpm --filter @entec/api build

      - name: Build Admin
        run: pnpm --filter @entec/admin build

      - name: Build Web
        run: pnpm --filter @entec/web build

  # ─── Tests ───
  test:
    name: Tests
    runs-on: ubuntu-latest
    needs: lint
    services:
      mongo:
        image: mongo:7
        ports:
          - 27017:27017
        options: >-
          --health-cmd "mongosh --eval 'db.adminCommand(\"ping\")'"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
    steps:
      - uses: actions/checkout@v4

      - uses: pnpm/action-setup@v4
        with:
          version: ${{ env.PNPM_VERSION }}

      - uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: pnpm

      - run: pnpm install --frozen-lockfile

      - name: Build shared packages
        run: |
          pnpm --filter @entec/shared build
          pnpm --filter @entec/ui build

      - name: Run API tests
        run: pnpm --filter @entec/api test
        env:
          MONGODB_URI: mongodb://localhost:27017/entec_test
          JWT_SECRET: test-secret
          JWT_REFRESH_SECRET: test-refresh-secret

      - name: Run Shared tests
        run: pnpm --filter @entec/shared test

  # ─── Docker Build ───
  docker:
    name: Docker Build
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main'
    steps:
      - uses: actions/checkout@v4

      - name: Build API image
        run: docker build -f apps/api/Dockerfile -t entec-api:${{ github.sha }} .

      - name: Build Admin image
        run: docker build -f apps/admin/Dockerfile -t entec-admin:${{ github.sha }} .

      - name: Build Web image
        run: docker build -f apps/web/Dockerfile -t entec-web:${{ github.sha }} .
